<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Dentodesk</title>
  <style>
    /* ========== ESTILOS LOGIN - CL√çNICA DENTAL CELESTE ========== */
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #e6f7fb, #ffffff);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    /* Caja principal */
    .login-container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 350px;
      text-align: center;
    }

    h1 {
      color: #33A9E0;
      margin-bottom: 0.5rem;
    }

    .subtitulo {
      color: #555;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 1.5rem;
    }

    .tabs button {
      flex: 1;
      padding: 0.5rem;
      border: none;
      cursor: pointer;
      font-weight: bold;
      background: #f0f8fb;
      color: #333;
      transition: all 0.3s ease;
    }

    .tabs button.active {
      background: #33A9E0;
      color: white;
      border-radius: 6px;
    }

    /* Formularios */
    .form {
      display: none;
      text-align: left;
    }

    .form.active {
      display: block;
    }

    label {
      display: block;
      margin: 0.5rem 0 0.2rem;
      color: #333;
      font-weight: 600;
    }

    input {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 1rem;
      box-sizing: border-box;
    }

    /* Bot√≥n principal */
    .btn {
      background: #33A9E0;
      color: white;
      border: none;
      padding: 0.7rem;
      width: 100%;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn:hover {
      background: #2893c5;
    }

    .btn-secondary {
      background: #f0f8fb;
      color: #33A9E0;
      border: 1px solid #33A9E0;
    }

    .btn-secondary:hover {
      background: #e0f0f7;
    }

    .info-message {
      background-color: #e6f7fb;
      border: 1px solid #33A9E0;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: #333;
    }

    .error-message {
      background-color: #ffe6e6;
      border: 1px solid #ff3333;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: #cc0000;
    }

    .success-message {
      background-color: #e6ffe6;
      border: 1px solid #33cc33;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: #006600;
    }

    .form-footer {
      margin-top: 15px;
      text-align: center;
      font-size: 0.9rem;
    }

    .form-footer a {
      color: #33A9E0;
      text-decoration: none;
      cursor: pointer;
    }

    .form-footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- ================= LOGIN PRINCIPAL ================= -->
  <div class="login-container">
    <h1>Dentodesk</h1>
    <p class="subtitulo">Acceso de pacientes y administrador</p>

    <!-- Tabs para cambiar entre Iniciar sesi√≥n y Registrar -->
    <div class="tabs">
      <button id="tabLogin" class="active">Iniciar sesi√≥n</button>
      <button id="tabRegister">Registrarse</button>
    </div>

    <!-- FORMULARIO DE LOGIN -->
    <form id="formLogin" class="form active">
      <div class="info-message">
        Sistema seguro de historias cl√≠nicas dentales
      </div>
      
      <label>DNI</label>
      <input type="text" id="loginDni" placeholder="Ingresa tu DNI">

      <label>Contrase√±a</label>
      <input type="password" id="loginPassword" placeholder="Contrase√±a">

      <div class="form-footer">
        <a id="forgotPasswordLink">¬øOlvidaste tu contrase√±a?</a>
      </div>

      <button type="submit" class="btn">Ingresar</button>
    </form>

    <!-- FORMULARIO DE REGISTRO -->
    <form id="formRegister" class="form">
      <div class="info-message">
        Para registrarse, necesitar√° verificar su correo electr√≥nico
      </div>
      
      <label>DNI</label>
      <input type="text" id="regDni" placeholder="DNI del paciente">

      <label>Nombre completo</label>
      <input type="text" id="regNombre" placeholder="Nombre completo">

      <label>Correo electr√≥nico</label>
      <input type="email" id="regEmail" placeholder="Correo electr√≥nico">

      <label>Contrase√±a</label>
      <input type="password" id="regPassword" placeholder="Contrase√±a (m√≠n. 8 caracteres)">

      <button type="submit" class="btn">Registrar</button>
    </form>

    <!-- FORMULARIO DE RECUPERACI√ìN DE CONTRASE√ëA -->
    <form id="formForgotPassword" class="form">
      <div class="info-message">
        Se enviar√° un c√≥digo de verificaci√≥n a su correo electr√≥nico registrado
      </div>
      
      <label>DNI</label>
      <input type="text" id="forgotDni" placeholder="Ingresa tu DNI">

      <button type="submit" class="btn">Enviar c√≥digo</button>
      <button type="button" id="backToLogin" class="btn btn-secondary">Volver al inicio de sesi√≥n</button>
    </form>

    <!-- FORMULARIO DE VERIFICACI√ìN DE C√ìDIGO -->
    <form id="formVerifyCode" class="form">
      <div class="info-message">
        Ingrese el c√≥digo de verificaci√≥n enviado a su correo electr√≥nico
      </div>
      
      <label>C√≥digo de verificaci√≥n</label>
      <input type="text" id="verificationCode" placeholder="C√≥digo de 6 d√≠gitos">

      <label>Nueva contrase√±a</label>
      <input type="password" id="newPassword" placeholder="Nueva contrase√±a">

      <button type="submit" class="btn">Restablecer contrase√±a</button>
      <button type="button" id="backToForgot" class="btn btn-secondary">Volver</button>
    </form>
  </div>

  <script>
  // ================= UTILIDADES DE SEGURIDAD =================
  
  // Generar un c√≥digo de verificaci√≥n de 6 d√≠gitos
  function generateVerificationCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // Simular env√≠o de correo de verificaci√≥n (al propio usuario)
  function sendVerificationEmail(email, code) {
    console.log(`Simulando env√≠o de c√≥digo ${code} al correo: ${email}`);
    alert(`Se ha enviado un c√≥digo de verificaci√≥n a ${email}. C√≥digo de prueba: ${code}`);
  }

  // Enviar solicitud de acceso al administrador (Dentodesk)
  function sendAccessRequestToAdmin(nombre, dni, email) {
    const adminEmail = "jhongam2418y@gmail.com";
    const subject = encodeURIComponent("Nueva solicitud de acceso a Dentodesk");
    const body = encodeURIComponent(
      `Hola administrador,\n\n` +
      `Un nuevo usuario ha solicitado acceso al sistema Dentodesk:\n\n` +
      `üë§ Nombre: ${nombre}\n` +
      `üÜî DNI: ${dni}\n` +
      `üìß Correo: ${email}\n\n` +
      `Por favor, revise si desea aprobar o rechazar esta solicitud.\n\n` +
      `-- Sistema Dentodesk`
    );
    window.open(`mailto:${adminEmail}?subject=${subject}&body=${body}`);
  }

  // Encriptar contrase√±as (simulaci√≥n)
  function hashPassword(password) {
    return btoa(password);
  }

  // Verificar contrase√±as (simulaci√≥n)
  function verifyPassword(password, hashedPassword) {
    return btoa(password) === hashedPassword;
  }

  // ================= GESTI√ìN DE FORMULARIOS =================
  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const formLogin = document.getElementById("formLogin");
  const formRegister = document.getElementById("formRegister");
  const formForgotPassword = document.getElementById("formForgotPassword");
  const formVerifyCode = document.getElementById("formVerifyCode");
  const forgotPasswordLink = document.getElementById("forgotPasswordLink");
  const backToLogin = document.getElementById("backToLogin");
  const backToForgot = document.getElementById("backToForgot");

  // Cambiar entre formularios
  function showForm(formToShow) {
    formLogin.classList.remove("active");
    formRegister.classList.remove("active");
    formForgotPassword.classList.remove("active");
    formVerifyCode.classList.remove("active");
    formToShow.classList.add("active");
  }

  tabLogin.addEventListener("click", () => {
    tabLogin.classList.add("active");
    tabRegister.classList.remove("active");
    showForm(formLogin);
  });

  tabRegister.addEventListener("click", () => {
    tabRegister.classList.add("active");
    tabLogin.classList.remove("active");
    showForm(formRegister);
  });

  forgotPasswordLink.addEventListener("click", () => {
    showForm(formForgotPassword);
  });

  backToLogin.addEventListener("click", () => {
    showForm(formLogin);
  });

  backToForgot.addEventListener("click", () => {
    showForm(formForgotPassword);
  });

  // ================= REGISTRAR PACIENTE =================
  formRegister.addEventListener("submit", e => {
    e.preventDefault();
    const dni = document.getElementById("regDni").value;
    const nombre = document.getElementById("regNombre").value;
    const email = document.getElementById("regEmail").value;
    const password = document.getElementById("regPassword").value;

    // Validaciones
    if (!dni || !nombre || !email || !password) {
      alert("Completa todos los campos");
      return;
    }

    if (password.length < 8) {
      alert("La contrase√±a debe tener al menos 8 caracteres");
      return;
    }

    // Verificar si el DNI ya est√° registrado
    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || {};
    if (usuarios[dni]) {
      alert("Ese DNI ya est√° registrado");
      return;
    }

    // Generar c√≥digo de verificaci√≥n
    const verificationCode = generateVerificationCode();
    
    // Guardar datos temporales
    let pendingRegistrations = JSON.parse(localStorage.getItem("pendingRegistrations")) || {};
    pendingRegistrations[dni] = {
      nombre,
      email,
      password: hashPassword(password),
      verificationCode,
      timestamp: Date.now()
    };
    localStorage.setItem("pendingRegistrations", JSON.stringify(pendingRegistrations));

    // Enviar correo al propio usuario
    sendVerificationEmail(email, verificationCode);

    // Enviar solicitud de acceso al administrador
    sendAccessRequestToAdmin(nombre, dni, email);

    // Aviso visual
    alert(`Se ha enviado una solicitud de acceso a Dentodesk.\nEl administrador revisar√° tu solicitud y recibir√°s un correo con el c√≥digo de verificaci√≥n en ${email}.`);

    // Cambiar autom√°ticamente al login
    tabLogin.click();
  });

  // ================= INICIAR SESI√ìN =================
  formLogin.addEventListener("submit", e => {
    e.preventDefault();
    const dni = document.getElementById("loginDni").value;
    const password = document.getElementById("loginPassword").value;

    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || {};

    if (usuarios[dni] && verifyPassword(password, usuarios[dni].password)) {
      const sessionData = { dni, timestamp: Date.now() };
      localStorage.setItem("usuarioActivo", JSON.stringify(sessionData));
      window.location.href = "index.html";
    } else {
      alert("DNI o contrase√±a incorrectos ‚ùå");
    }
  });

  // ================= RECUPERAR CONTRASE√ëA =================
  formForgotPassword.addEventListener("submit", e => {
    e.preventDefault();
    const dni = document.getElementById("forgotDni").value;
    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || {};

    if (!usuarios[dni]) {
      alert("No se encontr√≥ una cuenta asociada a este DNI");
      return;
    }

    const verificationCode = generateVerificationCode();
    let passwordResets = JSON.parse(localStorage.getItem("passwordResets")) || {};
    passwordResets[dni] = { verificationCode, timestamp: Date.now() };
    localStorage.setItem("passwordResets", JSON.stringify(passwordResets));

    sendVerificationEmail(usuarios[dni].email, verificationCode);
    showForm(formVerifyCode);
  });

  // ================= VERIFICAR C√ìDIGO Y CAMBIAR CONTRASE√ëA =================
  formVerifyCode.addEventListener("submit", e => {
    e.preventDefault();
    const dni = document.getElementById("forgotDni").value;
    const code = document.getElementById("verificationCode").value;
    const newPassword = document.getElementById("newPassword").value;

    let passwordResets = JSON.parse(localStorage.getItem("passwordResets")) || {};
    const resetData = passwordResets[dni];

    if (!resetData || resetData.verificationCode !== code) {
      alert("C√≥digo de verificaci√≥n incorrecto");
      return;
    }

    const now = Date.now();
    if (now - resetData.timestamp > 15 * 60 * 1000) {
      alert("El c√≥digo ha expirado. Solicite uno nuevo.");
      delete passwordResets[dni];
      localStorage.setItem("passwordResets", JSON.stringify(passwordResets));
      showForm(formForgotPassword);
      return;
    }

    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || {};
    if (usuarios[dni]) {
      usuarios[dni].password = hashPassword(newPassword);
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
      delete passwordResets[dni];
      localStorage.setItem("passwordResets", JSON.stringify(passwordResets));
      alert("Contrase√±a actualizada correctamente ‚úÖ");
      showForm(formLogin);
    } else {
      alert("Error al actualizar la contrase√±a");
    }
  });

  // ================= COMPLETAR REGISTRO =================
  function completeRegistration(dni, code) {
    let pendingRegistrations = JSON.parse(localStorage.getItem("pendingRegistrations")) || {};
    const pendingData = pendingRegistrations[dni];

    if (!pendingData || pendingData.verificationCode !== code) {
      alert("C√≥digo de verificaci√≥n incorrecto");
      return false;
    }

    const now = Date.now();
    if (now - pendingData.timestamp > 24 * 60 * 60 * 1000) {
      alert("El registro ha expirado. Reg√≠strese nuevamente.");
      delete pendingRegistrations[dni];
      localStorage.setItem("pendingRegistrations", JSON.stringify(pendingRegistrations));
      return false;
    }

    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || {};
    usuarios[dni] = {
      nombre: pendingData.nombre,
      email: pendingData.email,
      password: pendingData.password,
      role: "paciente"
    };
    localStorage.setItem("usuarios", JSON.stringify(usuarios));
    delete pendingRegistrations[dni];
    localStorage.setItem("pendingRegistrations", JSON.stringify(pendingRegistrations));

    alert("Registro completado correctamente ‚úÖ");
    return true;
  }

  window.completeRegistration = completeRegistration;
</script>

</body>
</html>


